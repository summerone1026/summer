<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../css/mui.css" rel="stylesheet" />
		<link href="../css/video-js.css" rel="stylesheet">
		<link rel="stylesheet" type="text/css" href="../css/iconfont.css"/>
		 <script src="../js/video.js"></script>
		<script src="../js/videojs-contrib-hls.min.js"></script>
		<script src="../js/mui.min.js"></script>
		<script src="../js/lib/common.js"></script>
		<script src="../js/lib/art-template.js" type="text/javascript" charset="utf-8"></script>
	</head>
	
	<style>
		#vodAd{
			width: 97%;
			height: 6.25rem;
			margin-left: 0.425rem;
			margin-right: 0.425rem;
			margin-top: 0.275rem;
			border-radius:3% 3% 3% 3%;
		}
		.vodInfo{
			max-width: 100%;
			color: #74858E;
			font-size: x-small;
			margin-left: 0.425rem;
		}
		#dianZan{
			font-size: large;
			color:#74858E;
			position: relative;
			top: 5px; 
			margin-right: 0.525rem;
		}
	</style>
		
	<header class="mui-bar mui-bar-nav">
		<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" id="muiBackButton"></a>
		<h5 class="mui-title" id="videoName"></h5>
	</header>
	<body>
		<div class="mui-content" id="videoNode">
			<!-- <video id="video" class="video-js vjs-big-play-centered vjs-fluid vjs-default-skin" controls="true" autoplay="false" topreload="auto" height="300" width="100%" loop="true" poster="" data-setup="{}"> <source src="https://d2zihajmogu5jn.cloudfront.net/bipbop-advanced/bipbop_16x9_variant.m3u8" type="application/x-mpegURL"> <p class="vjs-no-js">TEST</p> </video> -->
		</div>
		
		<div id="vodInfo">
			<span class="vodInfo">2019年8月26日 18点03分</span>&nbsp;<span class="vodInfo">播放次数：666</span>&nbsp;<span class="vodInfo">点赞人数：123</span>
		    <span id="dianZan" class="mui-icon iconfont icon-zan mui-pull-right" style="color:;"></span>
		</div>
		
		<hr />
		<img id="vodAd" src="../images/cbd.jpg" >
		
		<!-- 猜你喜欢 -->
		<hr />
		<div class="hometype">
			<span class="left">猜你喜欢</span>
		</div>
		<ul id="guessLike1" class="mui-table-view mui-grid-view" style="">			
			<script id="guessLike1Model" type="text/html">
				   {{each video as value}}
					<li class="mui-table-view-cell mui-media mui-col-xs-6" id="{{value.vod_id}}" name="{{value.vod_name}}" url="{{value.vod_play_url}}">
							<img class="mui-media-object" src="{{value.vod_pic}}">
							<div class="mui-media-body">{{value.vod_name}}</div> 
					</li>
					{{/each}}
			</script>
		</ul> 
	</body>
	
	<script type="text/javascript">
		mui.init();
		mui.plusReady(function(){
			var self = plus.webview.currentWebview();
			var videoId = self.videoId;
			var name = self.name;//获得参数
			var pic = self.pic;
			var src = self.src;

			//添加观影记录
			addVideoInformation(videoId, name, pic, src);
			
			//获取最新播放总数,并更新播放次数
			mui.getJSON(APP_DOMAIN + "/videos/" + videoId, function(data){
				var hits = data["vod_hits"];
				updateVideoHits(++hits);
				}
			);

			document.getElementById("videoName").innerHTML = name;
			document.getElementById("videoNode").innerHTML = '<video \
				id="video" \
				class="video-js vjs-big-play-centered vjs-fluid vjs-default-skin" \
				controls="true" \
				autoplay="ture" \
				topreload="auto" \
				height="300" \
				width="100%" \
				loop="true" \
				poster="" \
				data-setup="{}"> \
				<source src="' + src + '" type="application/x-mpegURL"> \
				<p class="vjs-no-js">TEST</p> \
				</video>';
			var options = {};
			var player = videojs('video', options, function onPlayerReady() {
			  videojs.log('Your player is ready!');

			  // In this context, `this` is the player that was created by Video.js.
			  //this.play();

			  //进入播放页面,解锁重力感应
			  plus.screen.unlockOrientation();
		
			  // How about an event listener?
			   this.on('play', function () {
				   console.log('开始/恢复播放');
			   });
			   this.on('pause', function () {
				   console.log('暂停播放');
				   this.pause();
			   });
			   this.on('ended', function () {
				   console.log('结束播放');
			   });
			   //解锁加锁方法在华为手机上结果相反,现采用进入播放器解锁屏幕重力感应,退出播放器时竖屏正方向锁定
			  //  this.on('fullscreenchange', function () {
				 //   console.log('全屏变化');
				 //   var isFullScreen = this.isFullscreen();
				 //   console.log('是否是全屏:' + isFullScreen);
					// if (isFullScreen) {
					// 	console.log('是全屏，解除屏幕锁定');
					// 	plus.screen.unlockOrientation();
					// }else{
					// 	console.log('不是全屏，执行屏幕锁定');
					// 	plus.screen.lockOrientation("portrait-primary"); 
					// }
			  //  });
			});
			
			plus.key.addEventListener("backbutton", function(){
				plus.screen.lockOrientation("portrait-primary");
			});
			document.getElementById("muiBackButton").addEventListener("tap", function(){
				plus.screen.lockOrientation("portrait-primary");				
			});
			
			function updateVideoHits(hits){
				var info = [];
				var data = {
						op: "replace",
						path: "/vod_hits",
						value: hits
					};
				info.push(data);
				mui.ajax(APP_DOMAIN + "/videos/" + videoId,{
					data:JSON.stringify(info),
					datatype:'json',//服务器返回json格式数据
					type:'patch',//HTTP请求类型
					timeout:10000,//超时时间设置为10秒；
					headers:{'Content-Type':'application/json'},
					success:function(data){
						//console.log(JSON.stringify(data));
					},
					error:function(xhr,type,errorThrown){
						
					}
				});				
			};
			loadVideoGuessLikeData();
		});
		
		//点赞
		mui('#vodInfo').on('tap','#dianZan',function(){
			document.getElementById('dianZan').style.color="red";
		})
		
		function loadVideoGuessLikeData(){
			mui.ajax(APP_DOMAIN + "/videos",{
				data:{limit:6, guess_like:true},
				datatype:"json",
				type:"get",
				timeout:5000,
				success:function(json){
					console.log("成功返回数据");
					var videoGuessLikeJson = new Array();
					videoGuessLikeJson["video"] = json;
					var html = template('guessLike1Model', videoGuessLikeJson)
					document.getElementById("guessLike1").innerHTML = html;
				},
				error:function(xhr,type,errorThrown){
					console.log("请求失败");
				}
			});	
		}
	</script>
</html>
